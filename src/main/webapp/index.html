<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css"
          integrity="sha384-TX8t27EcRE3e/ihU7zmQxVncDAy5uIKz4rEkgIXeMed4M0jlfIDPvg6uqKI2xXr2" crossorigin="anonymous">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.1/css/all.css"
          integrity="sha384-vp86vTRFVJgpjF9jiIGPEEqYqlDwgyBgEF109VFjmqGmIY/Y4HV4d3Gp2irVfcrp" crossorigin="anonymous">
    <link rel="stylesheet" href="css/index.css"/>

    <title>Ripetizioni</title>
</head>
<body>
<script src="https://cdn.jsdelivr.net/npm/vue@2.6.12"></script>
<section id="body-container">
    <!-- Navbar -->
    <nav class="d-flex flex-wrap flex-row navbar navbar-expand-md navbar-light">
        <button class="navbar-toggler mb-2 mb-md-0" type="button" data-toggle="collapse" data-target="#navbarNav"
                aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse mb-2 mb-md-0" id="navbarNav">
            <ul class="nav nav-pills mr-auto">
                <li class="nav-item">
                    <a class="nav-link active text-center" href="#">Prenota</a>
                </li>
                <li v-if="loggedIn" class="nav-item">
                    <a class="nav-link text-center" href="#">Prenotazioni</a>
                </li>
                <li v-if="isAdmin" class="nav-item">
                    <a class="nav-link text-center" href="#">Admin Console</a>
                </li>
            </ul>
        </div>
        <ul v-if="!loggedIn && sessionCheckEnded" class="nav ml-auto">
            <li class="nav-item">
                <a class="nav-link text-center btn btn-secondary" href="javascript:void(0)" data-toggle="modal"
                   data-target="#loginModal">Login</a>
            </li>
        </ul>
        <ul v-if="loggedIn && sessionCheckEnded" class="nav ml-auto">
            <li class="nav-item d-flex align-items-center justify-content-center">
                <div class="span12 mb-2 mb-md-0 mr-md-2">Benvenuto, {{username}}</div>
            </li>
            <li class="nav-item">
                <a class="nav-link text-center btn btn-danger" href="javascript:void(0)" v-on:click="logout">Logout</a>
            </li>
        </ul>
    </nav>
    <!-- End Navbar -->

    <!-- Login Modal -->
    <div v-if="!loggedIn && sessionCheckEnded" class="modal fade" id="loginModal" tabindex="-1" role="dialog"
         aria-labelledby="modal-container"
         aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header border-bottom-0">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                </div>
                <div class="form-title text-center">
                    <h4>Login</h4>
                </div>
                <div class="modal-body">
                    <div class="d-flex flex-column text-center">
                        <form>
                            <div class="form-group">
                                <input type="text" class="form-control" id="username"
                                       placeholder="Username" v-model="username">
                            </div>
                            <div class="form-group">
                                <input type="password" class="form-control" id="password"
                                       placeholder="Password" v-model="password">
                            </div>
                            <input type="button" class="btn btn-primary btn-block" value="Login"
                                   v-on:click="login">
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- End Modal -->

    <div class="d-flex flex-row justify-content-center flex-wrap p-2">
        <select style="max-width: 250px;" class="form-control m-2" v-model="selectedCourse" @change="selectChanged()">
            <option v-for="course in courses" :value="course.name">{{course.name}}</option>
        </select>
        <select style="max-width: 250px;" class="form-control m-2" v-model="selectedTeacher" @change="selectChanged()">
            <option v-for="teacher in teachers" :value="teacher.id">{{teacher.name}}
                {{teacher.surname}}
            </option>
        </select>
    </div>
    <div id="ripetizioni-container" class="text-center">
        <div v-if="lessonsFlag === true" class="d-flex flex-row justify-content-center flex-wrap p-2">
            <ripetizione v-for="lesson in lessons" v-bind:corso="lesson.course.name" v-bind:nome="lesson.teacher.name"
                         v-bind:cognome="lesson.teacher.surname" v-bind:id="lesson.teacher.id"
                         @lesson-emit="onLessonEmit"></ripetizione>
        </div>
        <p v-if="lessonsFlag === false" class="m-2">Non ci sono lezioni.</p>
        <img v-if="lessonsFlag === null" class="m-2" style="width: 70px" src="res/load.gif" alt="loading">
    </div>

    <!-- Calendar Modal -->
    <div v-if="lessonsFlag === true" class="modal fade" id="bookModal" tabindex="-1" role="dialog"
         aria-labelledby="modal-container"
         aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header border-bottom-0">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                </div>
                <div class="form-title text-center">
                    <h4>Calendario</h4>
                </div>
                <div class="modal-body">
                    <h5>{{lessonData.course}}</h5>
                    <h6>{{lessonData.name}} {{lessonData.surname}}</h6>
                    <div class="d-flex flex-column text-center">
                        <form>
                            <table class="table table-bordered table-sm">
                                <thead>
                                <tr>
                                    <th scope="col">#</th>
                                    <th scope="col">Lun</th>
                                    <th scope="col">Mar</th>
                                    <th scope="col">Mer</th>
                                    <th scope="col">Gio</th>
                                    <th scope="col">Ven</th>
                                </tr>
                                </thead>
                                <tbody id="calendarTable">
                                <tr>
                                    <th scope="row">15-16</th>
                                    <td class="green"></td>
                                    <td class="green"></td>
                                    <td class="green"></td>
                                    <td class="green"></td>
                                    <td class="green"></td>
                                </tr>
                                <tr>
                                    <th scope="row">16-17</th>
                                    <td class="green"></td>
                                    <td class="green"></td>
                                    <td class="green"></td>
                                    <td class="green"></td>
                                    <td class="green"></td>
                                </tr>
                                <tr>
                                    <th scope="row">17-18</th>
                                    <td class="green"></td>
                                    <td class="green"></td>
                                    <td class="green"></td>
                                    <td class="green"></td>
                                    <td class="green"></td>
                                </tr>
                                <tr>
                                    <th scope="row">18-19</th>
                                    <td class="green"></td>
                                    <td class="green"></td>
                                    <td class="green"></td>
                                    <td class="green"></td>
                                    <td class="green"></td>
                                </tr>
                                <tr>
                                    <th scope="row">19-20</th>
                                    <td class="green"></td>
                                    <td class="green"></td>
                                    <td class="green"></td>
                                    <td class="green"></td>
                                    <td class="green"></td>
                                </tr>
                                </tbody>
                            </table>
                            <input v-if="loggedIn && sessionCheckEnded" type="button" class="btn btn-success btn-block"
                                   value="Prenota">
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- End Modal -->

    <div class="toast fade hide" id="errorMessage" data-autohide="false" role="alert" aria-live="assertive"
         aria-atomic="true"
         style="width: 96%; max-width: 100%; position: absolute; top: 2%; right: 2%; left: 2%; z-index: 7000;">
        <div class="toast-header">
            <strong class="mr-auto badge badge-danger">ERROR</strong>
            <button type="button" class="ml-2 mb-1 close" data-dismiss="toast" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
        <div class="toast-body">
            Message
        </div>
    </div>

</section>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
        integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
        crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.min.js"
        integrity="sha384-w1Q4orYjBQndcko6MimVbzY0tgp4pWB4lZ7lr30WKz0vr/aWKhXdBNmNb5D92v7s"
        crossorigin="anonymous"></script>
<script>
    Vue.component('ripetizione', {
        props: ['corso', 'nome', 'cognome', 'id'],
        template: '<div class="card text-center m-2">\n' +
            '  <div class="card-body">\n' +
            '    <h5 class="card-title">{{corso}}</h5>\n' +
            '    <h6 :id="\'Docente-\' + id" class="card-subtitle mb-2 text-muted">{{nome}} {{cognome}}</h6>\n' +
            '    <button class="btn btn-primary" v-on:click="emitNames" data-toggle="modal" data-target="#bookModal">Show</button>\n' +
            '  </div>\n' +
            '</div>',
        methods: {
            emitNames: function () {
                this.$emit('lesson-emit', this.$props.nome, this.$props.cognome, this.$props.corso, this.$props.id);
            }
        },
    });

    var vuee = new Vue({
        el: "#body-container",
        data: {
            lessonsFlag: null,
            lessons: null,
            courses: null,
            teachers: null,
            username: null,
            password: null,
            isAdmin: false,
            loggedIn: false,
            sessionCheckEnded: false,
            message: "",
            lessonData: {
                name: null,
                surname: null,
                course: null,
                id: null
            },
            selectedCourse: "Seleziona Materia",
            selectedTeacher: 0,
            bookings: null,

        },
        mounted() {
            this.materie();
            this.docenti();
            this.lezioni(null, null);
            this.getSessionLogin();
        },
        methods: {
            materie: function () {
                const vm = this;
                $.get("Controller", {
                    action: "materie",
                }, function (data) {
                    if (data.message === "Ok") {
                        vm.courses = data.data;
                    } else {
                        vm.courses = null;
                    }
                });
            },
            docenti: function () {
                const vm = this;
                $.get("Controller", {
                    action: "docenti"
                }, function (data) {
                    if (data.message === "Ok") {
                        vm.teachers = data.data;
                    } else {
                        vm.teachers = null;
                    }
                });
            },
            lezioni: function (corso, docenteId) {
                const vm = this;
                $.get("Controller", {
                    action: "lessons",
                    course: corso,
                    teacherId: docenteId,
                }, function (data) {
                    if (data.message === "Ok") {
                        vm.lessons = data.data;
                        vm.lessonsFlag = true;
                    } else {
                        vm.lessonsFlag = false;
                        vm.lessons = null;
                    }
                });
            },
            login: function () {
                const vm = this;
                if (vm.username == null || vm.username === "" || vm.password == null || vm.password === "") {
                    vm.message = "Username e/o Password sbagliati";
                    return;
                }
                $.post("Controller", {
                    action: "login",
                    username: vm.username,
                    password: vm.password
                }, function (data) {
                    if (data.message === "Ok") {
                        vm.username = data.data.username;
                        vm.password = null;
                        vm.isAdmin = data.data.admin;
                        vm.loggedIn = true;
                        vm.message = "";
                        $('#loginModal').modal('hide');
                    } else {
                        vm.loggedIn = false;
                        vm.message = data.message;
                        $("#errorMessage").toast('show');
                    }
                });
            },
            getSessionLogin: function () {
                const vm = this;
                $.post("Controller", {
                    action: "getSessionLogin",
                }, function (data) {
                    if (data.message === "Sessione valida") {
                        vm.username = data.data.username;
                        vm.password = null;
                        vm.isAdmin = data.data.admin;
                        vm.loggedIn = true;
                    }
                    vm.sessionCheckEnded = true;
                });
            },
            logout: function () {
                const vm = this;
                $.get("Controller", {
                    action: "logout",
                }, function (data) {
                    vm.username = null;
                    vm.password = null;
                    vm.isAdmin = false;
                    vm.loggedIn = false;
                });
            },
            onLessonEmit: function (name, surname, course, id) {
                this.lessonData.name = name;
                this.lessonData.surname = surname;
                this.lessonData.course = course;
                this.lessonData.id = id;
                this.prenotazioniDocente();
            },
            selectChanged: function () {
                let invalidCourse = this.selectedCourse === "Seleziona Materia" || this.selectedCourse === "";
                let invalidTeacher = this.selectedTeacher === 0 || this.selectedTeacher === "";

                if (this.selectedCourse === "Seleziona Materia")
                    this.selectedCourse = "";
                if (this.selectedTeacher === 0)
                    this.selectedTeacher = "";

                this.lezioni(this.selectedCourse, this.selectedTeacher);

                if (invalidCourse)
                    this.selectedCourse = "Seleziona Materia";
                if (invalidTeacher)
                    this.selectedTeacher = 0;
            },
            updateCalendar: function () {
                const table = document.getElementById('calendarTable');

                //Reset all table cells to green
                for (let i = 0; i < table.children.length; i++) {
                    for (let j = 1; j < table.children[i].cells.length; j++)
                        table.children[i].cells[j].className = "green";
                }

                //Set red cells
                if (this.bookings.length > 0)
                    for (let i = 0; i < this.bookings.length; i++) {
                        let row = this.bookings[i].lessonSlot % 5;
                        let column = Math.trunc((this.bookings[i].lessonSlot / 5)) + 1;

                        if (this.bookings[i].username)
                            table.children[row].cells[column].className = "user-booked";
                        else
                            table.children[row].cells[column].className = "red";
                    }
            },
            prenotazioniDocente: function (corso, docenteId) {
                const vm = this;
                $.get("Controller", {
                    action: "prenotazioniDocente",
                    course: vm.lessonData.course,
                    teacherId: vm.lessonData.id,
                }, function (data) {
                    vm.bookings = data.data;
                    vm.updateCalendar();
                });
                return vm.bookings;
            },
        }
    });
</script>
</body>
</html>