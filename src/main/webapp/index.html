<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
          integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous"/>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.15.1/css/all.css"
          integrity="sha384-vp86vTRFVJgpjF9jiIGPEEqYqlDwgyBgEF109VFjmqGmIY/Y4HV4d3Gp2irVfcrp" crossorigin="anonymous">
    <link rel="stylesheet" href="css/index.css"/>

    <title>Ripetizioni</title>
</head>
<body>
<script src="https://cdn.jsdelivr.net/npm/vue@2.6.12"></script>
<section id="body-container">

    <!-- Navbar -->
    <nav class="d-flex flex-wrap flex-row">
        <ul class="nav nav-pills mr-auto">
            <li class="nav-item">
                <a class="nav-link active text-center" href="#">Prenota</a>
            </li>
            <li v-if="loggedIn" class="nav-item">
                <a class="nav-link text-center" href="#">Prenotazioni</a>
            </li>
            <li v-if="isAdmin" class="nav-item">
                <a class="nav-link text-center" href="#">Admin Console</a>
            </li>
        </ul>
        <template v-if="sessionCheckEnded">
            <ul v-if="!loggedIn" class="nav ml-auto">
                <li class="nav-item">
                    <a class="nav-link text-center btn btn-primary" href="javascript:void(0)" data-toggle="modal"
                       data-target="#loginModal">Login</a>
                </li>
            </ul>
            <template v-if="loggedIn">
                <ul class="nav ml-auto">
                    <li class="nav-item">
                        <div>Benvenuto, {{username}}</div>
                    </li>
                    <li class="nav-item">
                        <input type="button" class="nav-link text-center btn btn-danger btn-round" value="Logout"
                               v-on:click="logout()">
                    </li>
                </ul>
            </template>
        </template>
    </nav>
    <!-- End Navbar -->

    <!-- Modal -->
    <div class="modal fade" id="loginModal" tabindex="-1" role="dialog"
         aria-labelledby="modal-container"
         aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered" role="document">
            <div class="modal-content">
                <div class="modal-header border-bottom-0">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span
                            aria-hidden="true">&times;</span></button>
                </div>
                <div class="form-title text-center">
                    <h4>Login</h4>
                </div>
                <div class="modal-body">
                    <div class="d-flex flex-column text-center">
                        <form>
                            <div class="form-group">
                                <input type="text" class="form-control" id="username"
                                       placeholder="Username" v-model="username">
                            </div>
                            <div class="form-group">
                                <input type="password" class="form-control" id="password"
                                       placeholder="Password" v-model="password">
                            </div>
                            <input type="button" class="btn btn-primary btn-block btn-round" value="Login"
                                   v-on:click="login()">
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- End Modal -->

    <div v-if="lessonsFlag === true" class="d-flex flex-row justify-content-center flex-wrap p-2">
        <select style="max-width: 250px;" class="form-control m-2">
            <option v-for="course in courses" :value="course.name">{{course.name}}</option>
        </select>
        <select style="max-width: 250px;" class="form-control m-2">
            <option v-for="teacher in teachers" :value="'Docente-selected-' + teacher.id">{{teacher.name}}
                {{teacher.surname}}
            </option>
        </select>
    </div>
    <div id="ripetizioni-container" class="text-center">
        <div v-if="lessonsFlag === true" class="d-flex flex-row justify-content-center flex-wrap p-2"
             v-for="lesson in lessons">
            <ripetizione v-bind:corso="lesson.course.name" v-bind:nome="lesson.teacher.name"
                         v-bind:cognome="lesson.teacher.surname" v-bind:id="lesson.teacher.id"></ripetizione>
        </div>
        <p v-if="lessonsFlag === false" class="m-2">Non ci sono nuove lezioni.</p>
        <img v-if="lessonsFlag === null" class="m-2" style="width: 70px" src="res/load.gif" alt="loading">
    </div>

</section>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"
        integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
        integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>
<script>
    Vue.component('ripetizione', {
        props: ['corso', 'nome', 'cognome', 'id'],
        template: '<div class="card text-center m-2">\n' +
            '  <div class="card-body">\n' +
            '    <h5 class="card-title">{{corso}}</h5>\n' +
            '    <h6 :id="\'Docente-\' + id" class="card-subtitle mb-2 text-muted">{{nome}} {{cognome}}</h6>\n' +
            '    <a href="#" class="btn btn-primary">Show</a>\n' +
            '  </div>\n' +
            '</div>'
    });

    new Vue({
        el: "#body-container",
        data: {
            lessonsFlag: null,
            lessons: null,
            courses: null,
            teachers: null,
            username: null,
            password: null,
            isAdmin: false,
            loggedIn: false,
            sessionCheckEnded: false,
        },
        mounted() {
            this.materie();
            this.docenti();
            this.lezioni();
            this.getSessionLogin();
        },
        methods: {
            materie: function () {
                const vm = this;
                $.get("Controller", {
                    action: "materie"
                }, function (data) {
                    if (data.length > 1) {
                        vm.courses = data;
                    } else {
                        vm.courses = null;
                    }
                });
            },
            docenti: function () {
                const vm = this;
                $.get("Controller", {
                    action: "docenti"
                }, function (data) {
                    if (data.length > 1) {
                        vm.teachers = data;
                    } else {
                        vm.teachers = null;
                    }
                });
            },
            lezioni: function () {
                const vm = this;
                $.get("Controller", {
                    action: "lessons"
                }, function (data) {
                    if (data.length !== 0) {
                        vm.lessons = data;
                        vm.lessonsFlag = true;
                    } else {
                        vm.lessonsFlag = false;
                        vm.lessons = null;
                    }
                });
            },
            login: function () {
                const vm = this;
                $.post("Controller", {
                    action: "login",
                    username: vm.username,
                    password: vm.password
                }, function (data) {
                    console.log(data);
                    vm.username = data.username;
                    vm.password = null;
                    vm.isAdmin = data.admin;
                    vm.loggedIn = true;
                    $('#loginModal').modal('hide');
                });
            },
            getSessionLogin: function () {
                vm = this;
                $.post("Controller", {
                    action: "getSessionLogin",
                }, function (data) {
                    console.log(data);
                    if (data !== null) {
                        vm.username = data.username;
                        vm.password = null;
                        vm.isAdmin = data.admin;
                        vm.loggedIn = true;
                    }
                    vm.sessionCheckEnded = true;
                });
            },
            logout: function () {
                vm = this;
              $.post("Controller", {
                  action: "logout",
              }, function (data) {
                  vm.username = null;
                  vm.password = null;
                  vm.isAdmin = false;
                  vm.loggedIn = false;
              });
            },
        }
    });
</script>
</body>
</html>